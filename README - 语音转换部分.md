## 语音转换部分

> Stop Trying to Reinvent the Wheel

我们采用了业已成熟的 GPT -SoVITS 解决方案，调用其API来实现语音转换功能。我们以 Flask 写了负责与 SoVITS API 交互的 app.py ，在前后端之间架起了桥梁。前端使用 Vue 的组件式解决方案，写了 ModelSelector.vue 与 BroadcastInterface.vue 分别处理其模型训练、选择与直播时的语音转换流程控制的功能。


### 1. 后端服务架构

#### 1.1 TTS后端服务 (streamTTSBackend)

backend\streamTTSBackend\app.py 的逻辑结构：

1. **初始化阶段**
   - 创建Flask应用实例
   - 配置静态文件目录
   - 设置CORS策略

2. **请求处理流程**
   - 接收前端POST请求 → 验证输入参数 → 调用GPT-SoVITS API → 处理响应 → 返回音频URL
   - 错误处理链：参数校验 → API调用 → 文件保存 → 响应格式化

3. **资源管理**
   - 音频文件命名策略：时间戳+随机字符串
   - 文件清理机制：定期任务+按需删除

#### 1.2 GPT-SoVITS API服务

backend\GPT-SoVITS\api_v2.py 的核心逻辑：

1. **模型加载系统**
   - 动态权重切换机制
   - 模型热更新策略
   - 参考音频缓存管理

2. **语音合成流水线**
   - 文本预处理 → 特征提取 → 声学模型推理 → 声码器合成 → 后处理
   - 多线程处理队列

3. **流式传输实现**
   - 分块生成策略
   - 实时缓冲机制
   - 传输中断处理

### 2. 前端组件

#### 2.1 模型选择器

frontend\src\components\ModelSelector.vue的交互逻辑：

1. **状态管理**
   - 两级联动选择器数据流
   - 当前模型状态持久化
   - 参考音频索引映射

2. **测试流程**
   - 示例文本生成 → API调用 → 音频播放 → 结果反馈

3. **错误处理**
   - 模型加载失败 → 状态回滚
   - API错误 → 用户提示

#### 2.2 直播界面

frontend\src\components\BroadcastInterface.vue 的核心逻辑：

1. **语音合成队列**
   - 先进先出(FIFO)管理
   - 优先级插队机制
   - 取消处理流程

2. **播放控制系统**
   - 音频缓冲策略
   - 播放状态同步
   - 异常恢复机制

3. **字幕显示逻辑**
   - 当前句高亮
   - 下一句预览
   - 滚动同步

### 3. 系统交互时序

1. **初始化阶段**
   ```mermaid
   sequenceDiagram
      前端->>+后端: 获取可用模型列表
      后端-->>-前端: 返回模型配置
      前端->>模型选择器: 初始化下拉菜单
   ```

2. **语音合成流程**
   ```mermaid
   sequenceDiagram
      前端->>+TTS后端: 发送合成请求(文本)
      TTS后端->>+GPT-SoVITS: 转发请求
      GPT-SoVITS-->>-TTS后端: 返回音频流
      TTS后端->>文件系统: 保存音频
      TTS后端-->>-前端: 返回URL
      前端->>音频播放器: 加载播放
   ```

### 4. 扩展接口设计

1. **模型管理API**
   - POST /models - 添加新模型组
   - DELETE /models/{id} - 移除模型

2. **语音参数配置**
   - 语速/音调调节接口
   - 情感参数控制

3. **多语言支持**
   - 语言自动检测
   - 多语言模型切换