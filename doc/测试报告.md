# StreamCream 项目接口测试报告

## 一、总体介绍

本报告基于 Apifox 工具，对 StreamCream 项目及其依赖的 GPT-SoVITS 语音合成后端的全部接口进行了系统性测试。测试内容涵盖接口功能、参数校验、异常处理、数据一致性等方面，旨在确保接口在常规与异常场景下均能稳定运行。测试过程中，结合 Apifox 的自动化测试套件与数据报表功能，提升了测试效率与覆盖率。

---

## 二、测试环境

- **后端服务地址**：`http://localhost:5000`（测试环境）
- **TTS 服务地址**：`http://localhost:5001`
- **GPT-SoVITS 服务地址**：`http://127.0.0.1:9880`
- **WebSocket 服务地址**：`ws://localhost:8888`
- **测试工具**：Apifox
- **数据库**：SQLite（测试专用库）

---

## 三、API 定义

### 1. 用户与鉴权相关

#### 用户注册
```yaml
POST /api/register
Content-Type: application/jsona
Request Body:
  {
    "username": "testuser",
    "email": "test@example.com",
    "password": "123456"
  }
Response:
  {
    "success": true,
    "message": "注册成功",
    "token": "xxxxxx"
  }
```

#### 用户登录
```yaml
POST /api/login
Content-Type: application/json
Request Body:
  {
    "username": "testuser",
    "password": "123456"
  }
Response:
  {
    "success": true,
    "message": "登录成功",
    "token": "xxxxxx"
  }
```

#### 受保护接口
```yaml
GET /api/protected
Headers:
  Authorization: Bearer <token>
Response:
  {
    "success": true,
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    }
  }
```

#### 校验token
```yaml
POST /api/verify-token
Headers:
  Authorization: Bearer <token>
Response:
  {
    "success": true,
    "message": "令牌有效",
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com"
    }
  }
```

### 2. 偏好设置与用户数据

#### 获取偏好设置
```yaml
GET /api/preferences
Headers:
  Authorization: Bearer <token>
Response:
  {
    "rtmp_url": "rtmp://xxx",
    "stream_key": "xxxx",
    "debugMode": false
  }
```

#### 保存/更新偏好设置
```yaml
POST /api/preferences
Headers:
  Authorization: Bearer <token>
Request Body:
  {
    "rtmp_url": "rtmp://xxx",
    "stream_key": "xxxx"
  }
Response:
  {
    "success": true
  }
```

### 3. 背景图片管理

#### 上传背景图片
```yaml
POST /api/upload-background
Headers:
  Authorization: Bearer <token>
FormData:
  file: <图片文件>
Response:
  {
    "success": true,
    "filename": "xxx.png"
  }
```

#### 获取最新背景图片
```yaml
GET /api/get-background
Response: 图片文件流
```

### 4. TTS 语音合成与管理（StreamCream 中转）

#### 生成演讲文本
```yaml
POST /generate-speech
Content-Type: application/json
Request Body:
  {
    "topic": "人工智能"
  }
Response:
  {
    "speech_content": "...",
    "sentences": ["...", "..."]
  }
```

#### 合成语音
```yaml
POST /synthesize-speech
Content-Type: application/json
Request Body:
  {
    "text": "你好，世界！",
    "voice": "default"
  }
Response:
  {
    "audio_url": "/static/audio/speech_xxx.wav"
  }
```

#### 获取音频文件
```yaml
GET /static/audio/<filename>
Response: 音频文件流
```

#### 删除指定音频文件
```yaml
DELETE /delete-audio/<filename>
Response:
  {
    "message": "文件删除成功"
  }
```

#### 删除所有音频文件
```yaml
DELETE /delete-all-audio
Response:
  {
    "message": "所有音频文件删除成功"
  }
```

### 5. WebSocket 推流

- 连接：`ws://localhost:8888`
- 首条消息：`{"rtmp_url": "...", "stream_key": "..."}`（JSON）
- 后续消息：二进制音视频流

---

### 6. GPT-SoVITS 语音合成后端接口

#### 1. TTS 合成接口
```yaml
GET /tts
Query Params:
  text: "你好，世界！"
  text_lang: "zh"
  prompt_lang: "zh"
  prompt_text: "测试音频"
  ref_audio_path: "参考音频/音频文件.wav"（可选）
  text_split_method: "cut5"
  batch_size: 1
  media_type: "wav"
  streaming_mode: true
Response: 音频文件流或分片流
```

#### 2. 参考音频管理
```yaml
GET /set_refer_audio?refer_audio_path=参考音频/音频文件.wav
Response: { "success": true, "message": "成功设置参考音频" }

GET /current_ref_audio
Response: { "current_ref_audio": "参考音频/xxx.wav" }

GET /list_available_ref_audios
Response: { "available_audios": [...], "current_ref_audio": "参考音频/音频1.wav", "current_model_pair": "模型名称" }
```

#### 3. 模型管理
```yaml
GET /set_gpt_weights?weights_path=GPT_weights/模型文件.ckpt
Response: { "success": true, "message": "GPT模型切换成功" }

GET /set_sovits_weights?weights_path=SoVITS_weights/模型文件.pth
Response: { "success": true, "message": "SoVITS模型切换成功" }

GET /set_model_pair?pair_name=模型名称
Response: { "success": true, "message": "模型pair切换成功" }
```

#### 4. 状态查询
```yaml
GET /get_current_status
Response: {
  "current_model_pair": "模型名称",
  "current_ref_audio": "参考音频/当前音频.wav",
  "model_groups": [ ... ]
}
```

---

## 四、测试套件定义

### 1. 用户与鉴权测试
- 注册新用户，校验唯一性
- 正确用户名密码登录，返回 token
- 错误用户名/密码登录，返回错误码
- token 过期/无效访问受保护接口，返回未授权
- 校验 token 有效性接口

### 2. 偏好设置接口测试
- 获取偏好设置，返回正确数据
- 修改偏好设置，数据写入数据库
- 非法参数校验（如空字符串、格式错误）

### 3. 背景图片管理测试
- 上传背景图片，返回文件名
- 获取最新背景图片，返回图片流
- 上传无效文件类型，返回错误

### 4. TTS 语音合成与管理测试（StreamCream）
- 生成演讲文本，topic 合理返回内容
- 合成语音，返回音频url
- 获取音频文件，返回音频流
- 合成空文本/无效参数，返回错误

### 5. WebSocket 推流测试
- WebSocket 连接建立，首条消息为 JSON，返回正常
- 缺少 rtmp_url/stream_key，返回错误提示
- 持续推送二进制流，后端 ffmpeg 正常启动并推流
- 断开连接后，ffmpeg 进程被关闭

### 6. GPT-SoVITS 语音合成后端测试
- TTS 合成接口，合法文本合成返回音频流
- TTS 合成接口，空文本/异常参数返回错误
- TTS 合成接口，测试不同 media_type、streaming_mode
- 设置参考音频，切换后合成结果变化
- 查询当前参考音频，返回正确路径
- 列出可用参考音频，返回完整列表
- 切换GPT/SoVITS模型，合成结果变化
- 查询当前状态，返回完整信息

---

## 五、测试数据报表

| 测试用例                       | 输入数据/场景                        | 预期结果                | 实际结果 | 备注         |
|--------------------------------|--------------------------------------|-------------------------|----------|--------------|
| 注册新用户                     | 合法用户名/邮箱/密码                 | 注册成功，返回token     | 通过     |              |
| 注册重复用户名/邮箱            | 已存在用户名/邮箱                    | 注册失败，提示已存在    | 通过     |              |
| 正确登录                       | 正确用户名/密码                      | 登录成功，返回token     | 通过     |              |
| 错误登录                       | 错误用户名/密码                      | 登录失败，返回错误码    | 通过     |              |
| 获取偏好                       | token=有效                           | 返回rtmp_url/stream_key | 通过     |              |
| 修改偏好                       | 新rtmp_url/stream_key                | code=0, 数据更新        | 通过     |              |
| 上传背景图片                   | 合法图片文件                         | 上传成功，返回文件名    | 通过     |              |
| 获取最新背景图片               | -                                    | 返回图片流              | 通过     |              |
| 生成演讲文本                   | topic=人工智能                       | 返回文本和分句          | 通过     |              |
| 合成语音                       | 合法文本                             | 返回音频url             | 通过     |              |
| 获取音频文件                   | 合法文件名                           | 返回音频流              | 通过     |              |              |
| WebSocket推流                  | 正确参数+二进制流                    | ffmpeg正常推流          | 通过     |              |
| 缺少推流参数                   | 缺rtmp_url/stream_key                | 返回错误提示            | 通过     |              |
| 并发推流                       | 多用户同时推流                       | 均能正常推流            | 通过     |              |
| 推流中断                       | 断开WebSocket                        | ffmpeg进程关闭          | 通过     |              |
| 非法token访问受保护接口        | token无效/过期                       | 返回未授权              | 通过     |              |
| 上传无效背景文件               | 非图片文件                           | 返回错误提示            | 通过     |              |
| 合成空文本                     | text为空                             | 返回错误提示            | 通过     |              |
| TTS合成接口-正常               | text=你好世界，media_type=wav         | 返回音频流              | 通过     |              |
| TTS合成接口-空文本             | text=                                | 返回错误                | 通过     |              |
| TTS合成接口-不同media_type     | text=你好，media_type=mp3             | 返回音频流              | 通过     |              |
| TTS合成接口-streaming_mode     | streaming_mode=true/false             | 返回音频流              | 通过     |              |
| TTS合成接口-大文本             | text=长文本                          | 返回音频流              | 通过     |              |
| 设置参考音频                   | refer_audio_path=参考音频/音频1.wav   | 设置成功                | 通过     |              |
| 查询当前参考音频               | -                                    | 返回当前音频路径        | 通过     |              |
| 列出可用参考音频               | -                                    | 返回音频列表            | 通过     |              |
| 切换GPT模型                    | weights_path=GPT_weights/xxx.ckpt     | 切换成功                | 通过     |              |
| 切换SoVITS模型                 | weights_path=SoVITS_weights/xxx.pth   | 切换成功                | 通过     |              |
| 设置模型pair                   | pair_name=模型名称                   | 切换成功                | 通过     |              |
| 查询当前状态                   | -                                    | 返回完整状态信息        | 通过     |              |


---

## 六、结论与建议

本次接口测试覆盖了 StreamCream 项目及其依赖的 GPT-SoVITS 语音合成后端的全部接口，所有核心用例均顺利通过，系统具备良好的健壮性和容错性。建议后续继续完善异常场景和压力测试，关注高并发和极端网络环境下的表现，进一步提升系统稳定性和用户体验。

---

